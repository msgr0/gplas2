---
title: "report"
author: "Sergio Arredondo"
date: "7/17/2019"
output: html_document
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Precision and completeness of gplas

```{r precision_completeness}
library(tidyverse)

precision <- read.table(file = '../evaluation/overall_precision.tab')

colnames(precision) <- c('Sample','Species','Classifier','Factor','Number_iterations','Variance','Component','Tp_connections','Fp_connections','Precision')

precision$component_unique <- paste(precision$Sample,precision$Component, sep = '_')

precision$Sample <- gsub(pattern = '_ml', replacement = '', x = precision$Sample)
precision$Sample <- gsub(pattern = '_pflow', replacement = '', x = precision$Sample)

precision$Species <- gsub(pattern = '_', replacement = ' ', x = precision$Species)

completeness <- read.table(file = '../evaluation/overall_completeness.tab')

colnames(completeness) <- c('Sample','Species','Classifier','Factor','Number_iterations','Variance','Component','Size_component_contigs','Size_component_bp','Major_reference','Contigs_comp_reference','bp_comp_reference','Contigs_reference','bp_reference','completeness_contigs','completeness_bp', 'chromosomal_contigs','chromosomal_bp')

completeness$component_unique <- paste(completeness$Sample,completeness$Component, sep = '_')

completeness$Sample <- gsub(pattern = '_ml', replacement = '', x = completeness$Sample)
completeness$Sample <- gsub(pattern = '_pflow', replacement = '', x = completeness$Sample)

completeness$Species <- gsub(pattern = '_', replacement = ' ', x = completeness$Species)


no_component <- subset(completeness, completeness$Component == 'No_component')
component_present <- subset(completeness, completeness$Component != 'No_component')

completeness_precision <- merge(component_present, precision, by = 'component_unique')

single_components <- setdiff(component_present$component_unique, completeness_precision$component_unique)

single_components_precision <- NULL

for(comp in single_components)
{
  comp_info <- subset(completeness, completeness$component_unique == comp)
  comp_complete_info <- data.frame(Sample = comp_info$Sample,
                                   Species = comp_info$Species,
                                   Classifier = comp_info$Classifier,
                                   Factor = comp_info$Factor,
                                   Number_iterations = comp_info$Number_iterations,
                                   Variance = comp_info$Variance,
                                   Component = comp_info$Component,
                                   Tp_connections = 2,
                                   Fp_connections = 0,
                                   Precision = 1,
                                   component_unique = comp_info$component_unique)
  single_components_precision <- rbind(single_components_precision, comp_complete_info)
  
}

full_precision <- rbind(precision, single_components_precision)


full_completeness_precision <- merge(completeness, full_precision, by = 'component_unique')

full_completeness_precision$Precision_contigs <- full_completeness_precision$Contigs_comp_reference/full_completeness_precision$Size_component_contigs
full_completeness_precision$Precision_bp <- full_completeness_precision$bp_comp_reference/full_completeness_precision$Size_component_bp

full_completeness_precision$Precision[grep(pattern = 'Chromosome1', x = full_completeness_precision$Major_reference)] <- 0
full_completeness_precision$Precision_contigs[grep(pattern = 'Chromosome1', x = full_completeness_precision$Major_reference)] <- 0
full_completeness_precision$Precision_bp[grep(pattern = 'Chromosome1', x = full_completeness_precision$Major_reference)] <- 0

erase_components <- subset(full_completeness_precision, full_completeness_precision$Size_component_contigs == 1)
erase_components <- subset(erase_components, erase_components$completeness_contigs < 0.5)

full_completeness_precision <- subset(full_completeness_precision,! full_completeness_precision$component_unique %in% erase_components$component_unique)

report <- full_completeness_precision %>% group_by(Classifier.x, Species.x) %>% summarise(mean(Precision_contigs), mean(Precision_bp),mean(Precision),mean(completeness_contigs), mean(Size_component_bp))

classifier_results <- full_completeness_precision %>% group_by(Classifier.x) %>% summarise(mean(Precision_contigs), mean(Precision_bp),mean(Precision),mean(completeness_contigs), mean(Size_component_bp))


ggplot(report, aes(x = report$Species.x, y = report$`mean(Precision_contigs)`, color = report$Classifier.x, group = report$Classifier.x)) + geom_jitter(width = 0.1) + theme_bw() + theme(axis.text.x = element_text(angle = 90, hjust = 1)) 

ggplot(report, aes(x = report$Species.x, y = report$`mean(completeness_contigs)`, color = report$Classifier.x, group = report$Classifier.x)) + geom_jitter(width = 0.1) + theme_bw() + theme(axis.text.x = element_text(angle = 90, hjust = 1)) 

full_completeness_precision <- subset(full_completeness_precision, full_completeness_precision$Species.x == 'Enterococcus faecium')

# ggplot(full_completeness_precision, aes(x = full_completeness_precision$completeness_contigs, y = full_completeness_precision$Precision_contigs, color = full_completeness_precision$Major_reference,  label = full_completeness_precision$Size_component_bp), alpha = 0.1) + geom_point(size = 2.0) + theme_bw() + xlim(c(0,1.0)) + ylim(c(0,1.0)) + facet_wrap(full_completeness_precision$Sample.x ~ full_completeness_precision$Classifier.x) + labs(x = 'Completeness', y = 'Precision', size = 'Number of contigs', color = 'Reference sequence') + scale_size_area() + geom_label_repel()

```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
